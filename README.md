# Трассировка сетей

Модуль для автоматического отображения трассировки наружных инженерных систем по заданным точкам.

## Структура проекта

Проект разделен на `frontend` и `backend` согласно микросервисной архитектуре:

```
PP Project/
├── frontend/          # React приложение с Leaflet картой
├── backend/           # Node.js микросервисы
│   ├── gateway/       # API Gateway (порт 4000)
│   ├── tracing-service/  # Сервис трассировки (порт 4001)
│   ├── rules-service/    # Сервис правил (порт 4002)
│   └── src/db/       # Сервисы для работы с БД
├── database/          # PostgreSQL база данных
│   ├── tables/       # SQL файлы для создания таблиц
│   ├── init.sql      # Инициализация БД
│   └── README.md     # Документация по БД
├── TZ/                # Техническое задание
└── docs/              # Документация
    └── implementation-status.md  # Статус реализации
```

### Frontend

#### Базовая инфраструктура
- React 18 + TypeScript
- Vite для сборки
- ESLint настроен
- Leaflet карта интегрирована
- API клиент для интеграции с backend (axios)

#### Все 6 систем трассировки из ТЗ

1. **Водоснабжение** (`water`)
   - Две линии (двойной трубопровод)
   - Расстояние между линиями: 1.8 м
   - Цвет: синий (#0000ff)
   - Трасса с прямым углом 90°
   - Привязка к магистрали

2. **Канализация хоз-бытовая** (`sewerage`)
   - Одна линия
   - Минимальный угол 90° (без острых углов)
   - Цвет: коричневый (#8b4513)
   - Трасса с прямым углом 90°
   - Привязка к магистрали

3. **Ливневая канализация** (`storm`)
   - Одна линия
   - Минимальный угол 90° (без острых углов)
   - Цвет: темно-зеленый (#006400)
   - Трасса с прямым углом 90°
   - Привязка к магистрали

4. **Теплоснабжение** (`heating`)
   - Две линии (двойной трубопровод)
   - Расстояние между линиями: 1 м
   - Цвет: красный (#ff0000)
   - Трасса с прямым углом 90°
   - Привязка к магистрали

5. **Электроснабжение** (`power`)
   - Одна линия
   - Трансформаторная подстанция (ТП) отображается как квадрат 6×6 м
   - Трасса автоматически привязывается к ближайшей стороне квадрата ТП
   - Цвет: розовый (#ff69b4)
   - Трасса с прямым углом 90°

6. **Сети связи** (`telecom`)
   - Одна линия
   - Трансформаторная подстанция (ТП) отображается как квадрат 6×6 м
   - Трасса автоматически привязывается к ближайшей стороне квадрата ТП
   - Цвет: желтый (#ffd700)
   - Трасса с прямым углом 90°

#### Функциональность трассировки
- Интерактивная карта Leaflet с OpenStreetMap тайлами
- Выбор двух точек кликом по карте (начальная и конечная)
- Автоматическое построение трассы с прямым углом 90°
- Визуализация двойных линий для водоснабжения и теплоснабжения
- Маркеры для начальной и конечной точек трасс
- Временный маркер при выборе первой точки
- Очистка всех трасс одной кнопкой
- Легенда с условными обозначениями всех систем
- Индикатор статуса (какая точка выбирается)
- Управление слоями (скрытие/показ отдельных систем)

#### Работа с проектами
- Создание новых проектов
- Выбор проекта из списка
- Загрузка данных проекта при старте
- Сохранение всех данных в базу данных

#### Визуализация объектов
- Здания (прямоугольники с заданными размерами)
- Магистрали (пунктирные линии для водоснабжения, канализации, теплоснабжения)
- Трансформаторные подстанции (квадраты 6×6 м)
- Создание зданий (два клика: центр и размер)
- Создание магистралей (два клика: начало и конец)
- Создание ТП (один клик: центр)

#### UI/UX
- Боковая панель с выбором типа системы
- Инструкции для пользователя
- Адаптивный дизайн
- Стилизация компонентов
- Отображение ошибок валидации расстояний

### Backend

#### Микросервисная архитектура

1. **Gateway Service** (порт 4000)
   - Express сервер
   - CORS настроен
   - API endpoints для всех сущностей
   - Интеграция с базой данных PostgreSQL

2. **Tracing Service** (порт 4001)
   - Express сервер
   - Построение ортогональной трассы (90°)
   - Интеграция с rules-service
   - Конвертация расстояний в пиксели

3. **Rules Service** (порт 4002)
   - Express сервер
   - Хранение правил для всех 6 систем
   - API: `GET /rules/:system`
   - Возвращает: минимальный угол, двойная линия, расстояние в метрах

#### База данных PostgreSQL
- Подключение к PostgreSQL
- Все таблицы созданы:
  - `projects` - проекты трассировки
  - `buildings` - здания (точки ввода/выпуска)
  - `mainlines` - магистрали для подключения трасс
  - `transformer_stations` - трансформаторные подстанции
  - `traces` - трассы инженерных систем
  - `system_distances` - минимальные расстояния между системами (СП 42.13330.2016)
- Сервисы для работы с БД:
  - `projects-service.ts` - CRUD проектов
  - `buildings-service.ts` - CRUD зданий
  - `mainlines-service.ts` - CRUD магистралей
  - `transformer-stations-service.ts` - CRUD ТП
  - `traces-service.ts` - CRUD трасс
  - `distance-validator.ts` - валидация расстояний

#### API Endpoints

**Проекты:**
- `POST /api/projects` - создание проекта
- `GET /api/projects` - список проектов
- `GET /api/projects/:id` - получение проекта
- `PUT /api/projects/:id` - обновление проекта
- `DELETE /api/projects/:id` - удаление проекта

**Трассы:**
- `POST /api/traces` - создание трассы (с валидацией расстояний)
- `GET /api/traces/project/:projectId` - трассы проекта
- `DELETE /api/traces/:id` - удаление трассы

**Здания:**
- `POST /api/buildings` - создание здания
- `GET /api/buildings/project/:projectId` - здания проекта
- `DELETE /api/buildings/:id` - удаление здания

**Магистрали:**
- `POST /api/mainlines` - создание магистрали
- `GET /api/mainlines/project/:projectId` - магистрали проекта
- `DELETE /api/mainlines/:id` - удаление магистрали

**Трансформаторные подстанции:**
- `POST /api/transformer-stations` - создание ТП
- `GET /api/transformer-stations/project/:projectId` - ТП проекта
- `DELETE /api/transformer-stations/:id` - удаление ТП

#### Валидация расстояний
- Автоматическая проверка минимальных расстояний между системами по СП 42.13330.2016
- Валидация при создании трасс
- Возврат ошибок валидации клиенту
- Таблица `system_distances` с нормативными значениями

#### Конфигурация
- TypeScript для всех сервисов
- ESLint настроен
- package.json с зависимостями
- Скрипты для запуска сервисов

## Как запустить

### 1. База данных PostgreSQL

Сначала необходимо настроить базу данных:

```bash
cd database
# Windows
setup.bat
# Linux/Mac
./setup.sh
```

Или вручную:

```bash
psql -U postgres -f create_database.sql
psql -U postgres -d pp_project_db -f init.sql
```

**Параметры подключения:**
- Хост: `localhost`
- Порт: `5432`
- База данных: `pp_project_db`
- Пользователь: `postgres`
- Пароль: `123` (по умолчанию, можно изменить в `database/config.ts`)

### 2. Backend

#### Установка зависимостей:

```bash
cd backend
npm install
```

#### Запуск всех сервисов одновременно:

```bash
npm run dev:all
```

Сервисы будут доступны на:
- Gateway: `http://localhost:4000`
- Tracing Service: `http://localhost:4001`
- Rules Service: `http://localhost:4002`

#### Запуск отдельных сервисов:

```bash
# Gateway (порт 4000)
npm run dev:gateway

# Tracing Service (порт 4001)
npm run dev:tracing

# Rules Service (порт 4002)
npm run dev:rules
```

### 3. Frontend

```bash
cd frontend
npm install
npm run dev
```

Приложение откроется на `http://localhost:5173`

## Технологии

### Frontend
- React 18.3.1
- TypeScript 5.6.3
- Vite 5.4.0
- Leaflet 1.9.4
- react-leaflet 4.2.1

### Backend
- Node.js
- Express
- TypeScript
- PostgreSQL (pg)
- axios (для межсервисного взаимодействия)
- cors
